#!/usr/bin/env bash
# git-worktree-remove - Remove a worktree by branch name or path
#
# Usage: git worktree-remove <branch-name-or-path> [options]

# Source common functions and variables
source "$(dirname "$0")/git-worktree-common"

# Docker directory
DOCKER_DIR=~/workspace/workyard/dev-env/workyard-api

# Show help
if [ $# -eq 0 ] || [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    echo "Usage: git worktree-remove <branch-name-or-path> [options]"
    echo ""
    echo "Remove a git worktree by branch name or path."
    echo ""
    echo "Arguments:"
    echo "  branch-name    Name of the worktree branch (e.g., WORK-123-feature)"
    echo "  path           Full path to worktree (e.g., .worktrees/WORK-123-feature)"
    echo ""
    echo "Options:"
    echo "  --force        Force removal even with uncommitted changes"
    echo ""
    echo "Examples:"
    echo "  git worktree-remove WORK-123-feature"
    echo "  git worktree-remove .worktrees/WORK-123-feature"
    echo "  git worktree-remove WORK-123-feature --force"
    echo ""
    echo "This command will:"
    echo "  - Stop and remove worktree's Docker containers"
    echo "  - Delete the compose.worktree.{slug}.yaml file"
    echo "  - Remove the git worktree"
    exit 0
fi

# Check if in a git repository
check_git_repo

# Get repository root (use logical path for consistent absolute paths)
REPO_ROOT=$(get_repo_root_logical)
INPUT="$1"
shift  # Remove first argument, keep remaining args (like --force)

# Determine worktree path and branch name
if [[ "$INPUT" == .worktrees/* ]]; then
    # Already a path
    WORKTREE_PATH="$REPO_ROOT/$INPUT"
    BRANCH_NAME=$(basename "$INPUT")
elif [[ "$INPUT" == /* ]]; then
    # Absolute path
    WORKTREE_PATH="$INPUT"
    BRANCH_NAME=$(basename "$INPUT")
else
    # Branch name - convert to path
    WORKTREE_PATH="$REPO_ROOT/.worktrees/$INPUT"
    BRANCH_NAME="$INPUT"
fi

# Check if worktree exists
if [ ! -d "$WORKTREE_PATH" ]; then
    error "Worktree not found: $WORKTREE_PATH"
fi

# Get branch slug for container naming
BRANCH_SLUG=$(get_branch_slug "$BRANCH_NAME")

# Stop and remove Docker containers if they exist
if [ -d "$DOCKER_DIR" ]; then
    COMPOSE_FILE="$DOCKER_DIR/compose.worktree.${BRANCH_SLUG}.yaml"
    PROJECT_NAME="workyard-api-${BRANCH_SLUG}"

    if [ -f "$COMPOSE_FILE" ]; then
        info "Stopping Docker containers for: $BRANCH_SLUG"
        cd "$DOCKER_DIR"

        # Stop and remove containers
        if docker compose -f docker-compose.yml -f "compose.worktree.${BRANCH_SLUG}.yaml" \
            --project-name "$PROJECT_NAME" down 2>/dev/null; then
            success "Containers stopped"
        else
            warning "Failed to stop containers (may not have been running)"
        fi

        # Remove compose file
        info "Removing compose file: compose.worktree.${BRANCH_SLUG}.yaml"
        rm -f "$COMPOSE_FILE"
        success "Compose file removed"

        cd - >/dev/null
    else
        info "No compose file found for $BRANCH_SLUG - skipping Docker cleanup"
    fi
fi

# Remove the worktree
info "Removing worktree: $BRANCH_NAME"
git worktree remove "$WORKTREE_PATH" "$@"

success "Worktree removed successfully"
echo ""
echo "Removed:"
echo "  Worktree: $WORKTREE_PATH"
echo "  Branch:   $BRANCH_NAME"
if [ -d "$DOCKER_DIR" ]; then
    echo "  Containers: workyard-api-${BRANCH_SLUG}"
fi
