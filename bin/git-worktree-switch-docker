#!/usr/bin/env bash
# git-worktree-switch-docker - Switch Docker mount to different worktree
#
# DEPRECATED: This command switches all containers to one worktree at a time.
# Use 'git wt-docker' instead for parallel worktree support where each
# worktree gets its own isolated containers.
#
# Usage: git worktree-switch-docker <branch-name>
#        git worktree-switch-docker main

# Source common functions and variables
source "$(dirname "$0")/git-worktree-common"

# Show deprecation warning
warning "DEPRECATED: git-worktree-switch-docker is deprecated."
echo ""
echo "This command switches ALL containers to a single worktree."
echo "For parallel worktree support (recommended), use:"
echo ""
echo "  git wt-docker up -d       # Start containers for current worktree"
echo "  git wt-docker status      # Show container status"
echo "  git wt-docker exec ...    # Run commands in worktree containers"
echo ""
echo "Each worktree gets isolated containers at: api-{slug}.workyard.test"
echo ""
echo "Continuing with legacy behavior..."
echo ""

# Docker directory (hardcoded for crew-api, could be made generic later)
DOCKER_DIR=~/workspace/workyard/dev-env/workyard-api
ENV_FILE="$DOCKER_DIR/.env"

# Show help
if [ $# -eq 0 ] || [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    echo "Usage: git worktree-switch-docker <branch-name>"
    echo "       git worktree-switch-docker main"
    echo "       git worktree-switch-docker status"
    echo ""
    echo "Switch Docker containers to mount a different git worktree."
    echo ""
    echo "Examples:"
    echo "  git worktree-switch-docker WORK-123-feature    # Switch to worktree"
    echo "  git worktree-switch-docker main                # Switch back to main"
    echo "  git worktree-switch-docker status              # Show current selection"
    echo ""
    echo "The selection is saved to .env and persists across sessions."
    exit 0
fi

# Show status
if [ "$1" = "status" ]; then
    if [ -f "$ENV_FILE" ] && grep -q "^CREW_API_MOUNT_PATH=" "$ENV_FILE"; then
        CURRENT_PATH=$(grep "^CREW_API_MOUNT_PATH=" "$ENV_FILE" | cut -d'=' -f2)
        CURRENT_BRANCH=$(grep "^CREW_API_ACTIVE_BRANCH=" "$ENV_FILE" | cut -d'=' -f2)
        CURRENT_GIT_DIR=$(grep "^CREW_API_GIT_DIR=" "$ENV_FILE" | cut -d'=' -f2)

        echo "Docker currently pointing to: $CURRENT_PATH"
        echo "Active branch: $CURRENT_BRANCH"
        echo "Git directory: $CURRENT_GIT_DIR"
    else
        echo "Docker using default mount: ./crew-api (main)"
    fi
    echo ""
    echo "Configuration file: $ENV_FILE"
    exit 0
fi

BRANCH=$1

# Get repository root (use logical path for consistent absolute paths)
check_git_repo
REPO_ROOT=$(get_repo_root_logical)

# Determine mount path and git directory
if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "." ]; then
    # Main branch
    MOUNT_PATH="./crew-api"
    GIT_DIR="/opt/crew-api.git"
    info "Switching to main branch"
else
    # Check if worktree exists
    WORKTREE_PATH="$REPO_ROOT/.worktrees/$BRANCH"
    if [ ! -d "$WORKTREE_PATH" ]; then
        error "Worktree not found: $WORKTREE_PATH"
    fi

    # Use relative path from docker directory for mount
    MOUNT_PATH="./crew-api/.worktrees/$BRANCH"
    # Git directory points to worktree-specific metadata
    GIT_DIR="/opt/crew-api.git/worktrees/$BRANCH"
    info "Switching to worktree: $BRANCH"
fi

# Write selection to .env file (persists across sessions)
cd "$DOCKER_DIR"

# Write all three required variables to .env
cat > "$ENV_FILE" <<EOF
CREW_API_ACTIVE_BRANCH=$BRANCH
CREW_API_MOUNT_PATH=$MOUNT_PATH
CREW_API_GIT_DIR=$GIT_DIR
EOF

info "Configuration saved to .env:"
info "  Branch: $BRANCH"
info "  Mount path: $MOUNT_PATH"
info "  Git directory: $GIT_DIR"

# Restart containers with new mount (stop + start to pick up volume changes)
info "Restarting containers..."
task restart:crew-api

echo ""
success "Docker switched successfully!"
echo ""
echo "Active branch: $BRANCH"
echo "URL: https://api.workyard.test"
echo ""

# Show which containers were restarted
docker compose ps nginx workyard-api workyard-api-queue
