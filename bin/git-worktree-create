#!/usr/bin/env bash
# git-worktree-create - Create a new git worktree
#
# Usage: git worktree-create <branch-name> [base-branch]
#        git worktree-create WORK-123-oauth-integration
#        git worktree-create WORK-123-oauth-integration main

# Source common functions and variables
source "$(dirname "$0")/git-worktree-common"

# Show help
if [ $# -eq 0 ] || [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    echo "Usage: git worktree-create <branch-name> [base-branch]"
    echo ""
    echo "Create a new git worktree for parallel branch development."
    echo ""
    echo "Arguments:"
    echo "  branch-name   Name of the branch to create (e.g., WORK-123-feature)"
    echo "  base-branch   Base branch to branch from (default: main)"
    echo ""
    echo "Examples:"
    echo "  git worktree-create WORK-123-oauth-integration"
    echo "  git worktree-create WORK-123-oauth-integration main"
    echo ""
    echo "Features:"
    echo "  - Creates worktree in hidden .worktrees/ folder"
    echo "  - Copies PHPStorm settings from main worktree"
    echo "  - Automatically switches Docker to new worktree"
    echo "  - Installs PHP dependencies in container (via task install-dep:crew-api)"
    exit 0
fi

# Check if in a git repository
check_git_repo

BRANCH_NAME="$1"
BASE_BRANCH="${2:-main}"

# Get repository root (works correctly from both main repo and worktrees)
REPO_ROOT=$(get_repo_root)
WORKTREE_DIR="$REPO_ROOT/.worktrees/$BRANCH_NAME"

# Check if worktree already exists
if [ -d "$WORKTREE_DIR" ]; then
    error "Worktree already exists at: $WORKTREE_DIR"
fi

# Check if branch already exists
if git show-ref --verify --quiet "refs/heads/$BRANCH_NAME"; then
    warning "Branch '$BRANCH_NAME' already exists, will checkout existing branch"
    BRANCH_EXISTS=true
else
    info "Creating new branch '$BRANCH_NAME' from '$BASE_BRANCH'"
    BRANCH_EXISTS=false
fi

# Create .worktrees directory if it doesn't exist
mkdir -p "$REPO_ROOT/.worktrees"

# Create the worktree
info "Creating worktree at: $WORKTREE_DIR"
if [ "$BRANCH_EXISTS" = true ]; then
    git worktree add "$WORKTREE_DIR" "$BRANCH_NAME"
else
    git worktree add -b "$BRANCH_NAME" "$WORKTREE_DIR" "$BASE_BRANCH"
fi

success "Worktree created successfully"

# Copy .idea/ directory from main worktree if it exists
if [ -d "$REPO_ROOT/.idea" ]; then
    info "Copying PHPStorm settings from main worktree"
    cp -r "$REPO_ROOT/.idea" "$WORKTREE_DIR/"
    success "PHPStorm settings copied"
else
    info "No .idea/ directory found in main worktree"
fi

# Switch Docker to new worktree and install dependencies
DOCKER_DIR=~/workspace/workyard/dev-env/workyard-api

if [ -d "$DOCKER_DIR" ]; then
    echo ""
    info "Switching Docker to new worktree..."

    # Switch Docker mount to new worktree
    if git-worktree-switch-docker "$BRANCH_NAME" >/dev/null 2>&1; then
        success "Docker switched to $BRANCH_NAME"

        # Wait for containers to be healthy
        info "Waiting for containers to be ready..."
        sleep 5

        # Install PHP dependencies in container
        info "Installing PHP dependencies..."
        cd "$DOCKER_DIR"
        if task install-dep:crew-api; then
            success "Dependencies installed successfully"
        else
            warning "Failed to install dependencies - you may need to run 'task install-dep:crew-api' manually"
        fi
        cd - >/dev/null
    else
        warning "Failed to switch Docker - you may need to run 'git wt-docker $BRANCH_NAME' manually"
    fi
else
    info "Docker directory not found - skipping dependency installation"
    echo "  To install dependencies manually, run: git wt-docker $BRANCH_NAME && cd $DOCKER_DIR && task install-dep:crew-api"
fi

echo ""
success "All done!"
echo ""
echo "Next steps:"
echo "  cd $WORKTREE_DIR"
